---
- name: Update APT Repos and Upgrade APT Packages
  ansible.builtin.apt:
    update_cache: true
    upgrade: "yes"
    autoremove: true
    autoclean: true
  become: true

- name: Install
  ansible.builtin.apt:
    name:
      - jq
      - open-iscsi
    state: present
  become: true

- name: Set sudo
  ansible.builtin.template:
    src: user-sudo.j2
    dest: "/etc/sudoers.d/{{ ansible_env['USER'] }}"
    mode: 0644
  become: true

- name: Set hosts
  ansible.builtin.template:
    dest: "/etc/hosts"
    src: hosts.j2
    mode: 0644
  become: true
  when: not ansible_host_environment_is_wsl

- name: WSL config
  block:
    - name: Ensure /etc/wsl.conf exists
      ansible.builtin.file:
        path: /etc/wsl.conf
        state: touch
        mode: 0644

    - name: Disable generateResolvConf
      ansible.builtin.blockinfile:
        path: /etc/wsl.conf
        block: |
          [network]
          generateResolvConf = false
        state: present

    # This is needed to remove any symLinks for this file
    - name: Delete /ect/resolv.conf
      ansible.builtin.file:
        path: /ect/resolv.conf
        state: absent
        force: true

    - name: Ensure /ect/resolv.conf exists
      ansible.builtin.file:
        path: /ect/resolv.conf
        state: touch
        mode: 0644
        force: true

    - name: Set nameserver in /ect/resolv.conf
      ansible.builtin.blockinfile:
        path: /ect/resolv.conf
        block: |
          nameserver 1.1.1.1
        state: present
  become: true
  when: ansible_host_environment_is_wsl
